## æè¿°

[[@naihuJavaScriptBianYiJIT]]
[[@linclarkCrashCourseJustintime]]

### JIT å¼•å…¥è‡³ JavaScript

> ## JIT

> JavaScript åˆšå‡ºç°çš„æ—¶å€™ï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„è§£é‡Šå‹è¯­è¨€ï¼Œå› æ­¤è¿è¡Œé€Ÿåº¦ææ…¢ï¼Œåæ¥æµè§ˆå™¨å¼•å…¥äº† **JIT compiler**ï¼Œå¤§å¹…æé«˜äº† JavaScript çš„è¿è¡Œé€Ÿåº¦ã€‚

> åŸç†ï¼šThey added a new part to the JavaScript engine, called a monitor (aka a profiler). That monitor watches the code as it runs, and **makes a note of how many times it is run and what types are used**.  

> ç®€å•æ¥è¯´ï¼Œæµè§ˆå™¨åœ¨ JavaScript engine ä¸­åŠ å…¥äº†ä¸€ä¸ª monitorï¼Œç”¨æ¥è§‚å¯Ÿè¿è¡Œçš„ä»£ç ã€‚å¹¶è®°å½•ä¸‹æ¯æ®µä»£ç è¿è¡Œçš„æ¬¡æ•°å’Œä»£ç ä¸­çš„å˜é‡çš„ç±»å‹ã€‚

> é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆè¿™æ ·åšèƒ½æé«˜è¿è¡Œé€Ÿåº¦ï¼Ÿ  
> åé¢çš„æ‰€æœ‰å†…å®¹éƒ½ä»¥ä¸‹é¢è¿™ä¸ªå‡½æ•°çš„è¿è¡Œä¸ºä¾‹

```js
function arraySum(arr) {
  var sum = 0;
  for (var i = 0; i < arr.length; i++) {
    sum += arr[i];
  }
}
```

é‡é»ï¼š
- JavaScript åœ¨JITä¹‹å‰ï¼Œæ˜¯å±¬æ–¼å°‡åŸå§‹ç¢¼ç·¨è­¯æˆä¸­é–“ç¢¼ï¼Œä¸¦å­˜æ–¼è¨˜æ†¶é«”æˆ–è€…ç·©å­˜ï¼Œæ¥è‘—å†é‚Šè½‰ä¸­é–“ç¢¼ç‚ºæ©Ÿæ¢°ç¢¼é‚ŠåŸ·è¡Œ
[[JavaScript æ˜¯ä¸€å€‹å…·æœ‰ç·¨è­¯ã€ç›´è­¯ç‰¹æ€§çš„ç›´è­¯èªè¨€ï¼ŒåŸ·è¡Œå‰æœƒå…ˆç·¨è­¯ä¸­é–“ç¢¼ç„¶å¾Œé‚Šè§£æé‚ŠåŸ·è¡Œ]]
- JIT ä¾†è‡¨æ™‚ï¼ŒJavaScript æœƒä¾æ“šæ¯å€‹ç¨‹å¼ç¢¼çš„åŸ·è¡Œé »ç‡ä¾†é€²ä¸€æ­¥ç·¨è­¯æˆæ›´ç‚ºæ•ˆç‡çš„ç¨‹å¼ç¢¼ï¼Œä¸»è¦æœƒä½¿ç”¨monitorï¼Œå…¶monitoræœƒè² è²¬ï¼š
	- è§€å¯Ÿæ­£åœ¨åŸ·è¡Œçš„ç¨‹å¼ç¢¼ï¼Œä¸¦å°‡ç‚ºæ¯æ®µç¨‹å¼ç¢¼çš„**è¡Œæ•¸**å’Œ**æ‰€ç”¨åˆ°çš„è³‡æ–™é¡å‹**ä½œç‚ºç´¢å¼•ï¼Œä¸¦ä»¥æ­¤è¨ˆç®—ç¨‹å¼ç¢¼çš„åŸ·è¡Œæ¬¡æ•¸
- åŸ·è¡Œæ¬¡æ•¸è¶…éx1ï¼Œå°±æœƒå°‡å°æ‡‰ç´¢å¼•çš„ä»£ç¢¼è¨­å®šç‚ºwarmï¼›å¦‚æœåŸ·è¡Œæ¬¡æ•¸è¶…éx1ä¸”åˆè¶…éx2ï¼Œå°±æœƒå°‡å°æ‡‰ç´¢å¼•çš„ä»£ç¢¼è¨­å®šhotï¼Œä¾†åˆ†åˆ¥ä½¿ç”¨é »ç‡ä½å’Œé«˜ã€‚
- ä¾æ“šmonitoræ‰€å¾—åˆ°çš„æ¬¡æ•¸ï¼Œæœƒå°‡æ¬¡æ•¸é«˜çš„ç¨‹å¼ç¢¼è©¦è‘—å†ä¸‹ä¸€æ¬¡åŸ·è¡Œå‰å„ªåŒ–æˆæ›´ç‚ºæ•ˆç‡çš„æ©Ÿæ¢°ç¢¼ï¼Œå…·é«”æœƒç”±ï¼š
	- Baseline Compilerï¼šä¾æ“šç´¢å¼•å€¼ä¾†çµ¦å®šå°æ‡‰æ¯æ¬¡è§£æå¾—åˆ°çš„æ©Ÿæ¢°ç¢¼ï¼Œä¸‹æ¬¡åŸ·è¡Œæ™‚ç›´æ¥å¾é€™å–å‡ºæ©Ÿæ¢°ç¢¼åŸ·è¡Œï¼Œä¸ç”¨å†è§£æ
	- Optimizing Compilerï¼šä¾æ“šç´¢å¼•å€¼ä¾†çµ¦å®šå°æ‡‰æ¯æ¬¡è§£æå¾—åˆ°çš„æ©Ÿæ¢°ç¢¼ï¼Œä¸‹æ¬¡åŸ·è¡Œæ™‚ç›´æ¥å¾é€™å–å‡ºæ©Ÿæ¢°ç¢¼åŸ·è¡Œï¼Œä¸ç”¨å†è§£æï¼Œä½†é€™è£¡çš„æ©Ÿæ¢°ç¢¼æœƒæ¯”Baseline Compilerä¾†å¾—æœ‰æ•ˆç‡

### Interpreter 

> ## 1st step - Interpreter

> ä¸€å¼€å§‹åªæ˜¯ç®€å•çš„ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Œå½“æŸä¸€è¡Œä»£ç è¢«æ‰§è¡Œäº†å‡ æ¬¡ï¼Œè¿™è¡Œä»£ç ä¼šè¢«æ‰“ä¸Š **Warm** çš„æ ‡ç­¾ï¼›å½“æŸä¸€è¡Œä»£ç è¢«æ‰§è¡Œäº†å¾ˆå¤šæ¬¡ï¼Œè¿™è¡Œä»£ç ä¼šè¢«æ‰“ä¸Š **Hot** çš„æ ‡ç­¾

![](https://pic2.zhimg.com/80/v2-235cefb3de1873276264e6597d3d0819_720w.jpg)


é‡é»ï¼šç•¶JavaScriptè¢«ç·¨è­¯æˆByteCodeæ™‚ï¼Œæ­¤æ™‚æ˜¯å‰›åŸ·è¡Œçš„éšæ®µï¼Œ
- ç”±æ–¼æ¯æ®µç¨‹å¼ç¢¼éƒ½æ˜¯å‰›åŸ·è¡Œï¼Œæ‰€ä»¥ä¸€é–‹å§‹éƒ½æœƒæŒ‰ç…§è§£é‡‹å™¨é‚Šè§£æé‚ŠåŸ·è¡Œ
- æ¯æ®µç¨‹å¼ç¢¼éƒ½æœƒåœ¨åŸ·è¡Œæ™‚éƒ½æ ¹æ“šè¡Œæ•¸ã€è³‡æ–™é¡å‹ä¾†ç•¶ç´¢å¼•åœ¨monitoré‚£é‚Šæ›´æ–°å°æ‡‰çš„åŸ·è¡Œæ¬¡æ•¸ï¼š
	- å¦‚æœç´¢å¼•åœ¨monitoræ˜¯ä¸å­˜åœ¨çš„è©±ï¼Œå°±å»ºç«‹ç´¢å¼•ä»¥åŠå°æ‡‰çš„åŸ·è¡Œæ¬¡æ•¸ç‚º1
	- å¦‚æœç´¢å¼•åœ¨monitoræ˜¯å­˜åœ¨çš„è©±ï¼Œå°±ä»¥å°æ‡‰ç´¢å¼•ä¾†å¢åŠ å°æ‡‰åŸ·è¡Œæ¬¡æ•¸ï¼Œå¦‚count = count + 1

### Baseline Compiler

> ## 2nd step - Baseline compiler

> è¢«æ‰“ä¸Š **Warm** æ ‡ç­¾çš„ä»£ç ä¼šè¢«ä¼ ç»™ **Baseline Compiler** ç¼–è¯‘ä¸”å‚¨å­˜ï¼ŒåŒæ—¶æŒ‰ç…§**è¡Œæ•° (Line number)** å’Œ**å˜é‡ç±»å‹ (Variable type)** è¢«ç´¢å¼•ï¼ˆä¸ºä»€ä¹ˆä¼šå¼•å…¥å˜é‡ç±»å‹åšç´¢å¼•å¾ˆé‡è¦ï¼Œåé¢ä¼šè®²ï¼‰

> å½“å‘ç°æ‰§è¡Œçš„ä»£ç å‘½ä¸­ç´¢å¼•ï¼Œä¼šç›´æ¥å–å‡ºç¼–è¯‘åçš„ä»£ç æ‰§è¡Œï¼Œä»è€Œä¸éœ€è¦é‡å¤ç¼–è¯‘å·²ç»ç¼–è¯‘è¿‡çš„ä»£ç 


![](https://pic1.zhimg.com/80/v2-de48ac228fa2e580ee301097df649dfc_720w.jpg)

é‡é»ï¼šä½¿ç”¨æ¬¡æ•¸è¶…éx1å°±ç‚ºwarmï¼Œä½¿ç”¨æ¬¡æ•¸è¶…éx1ä¸”è¶…éx2å°±ç‚ºhot
- ä½¿ç”¨æ¬¡æ•¸æ¬¡æ•¸è¶…éx1ä½†ä¸¦ä¸è¶…éx2 çš„ ç´¢å¼•æ‰€å°æ‡‰çš„ç¨‹å¼ç¢¼æœƒæ”¾åœ¨Baseline Compiler


### Optimizing compiler

> ## 3rd step - Optimizing compiler

> è¢«æ‰“ä¸Š **Hot** æ ‡ç­¾çš„ä»£ç ä¼šè¢«ä¼ ç»™ **Optimizing compiler**ï¼Œè¿™é‡Œä¼šå¯¹è¿™éƒ¨åˆ†å¸¦ç åšæ›´ä¼˜åŒ–çš„ç¼–è¯‘ã€‚æ€ä¹ˆæ ·åšæ›´ä¼˜åŒ–çš„ç¼–è¯‘å‘¢ï¼Ÿå…³é”®ç‚¹å°±åœ¨è¿™é‡Œï¼Œæ²¡æœ‰åˆ«çš„åŠæ³•ï¼Œåªèƒ½ç”¨æ¦‚ç‡æ¨¡å‹åšä¸€äº›åˆç†çš„ **â€å‡è®¾ (Assumptions)â€œ**ã€‚

![](https://pic1.zhimg.com/80/v2-ee45b1a7a7c68f1a4ba46c5a376ba18c_720w.jpg)

> æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢çš„å¾ªç¯ä¸­çš„ä»£ç  `sum += arr[i]`ï¼Œå°½ç®¡è¿™é‡Œåªæ˜¯ç®€å•çš„ `+` è¿ç®—å’Œèµ‹å€¼ï¼Œä½†æ˜¯å› ä¸º JavaScript çš„**åŠ¨æ€ç±»å‹ (Dynamic typing)**ï¼Œå¯¹åº”çš„ç¼–è¯‘ç»“æœæœ‰å¾ˆå¤šç§å¯èƒ½ï¼ˆè¿™ä¸ªè§’åº¦èƒ½å¾ˆæ˜æ˜¾çš„æš´éœ²åŠ¨æ€ç±»å‹çš„ç¼ºç‚¹ï¼‰

> æ¯”å¦‚

> -   sum æ˜¯ Intï¼Œarr æ˜¯ Arrayï¼Œi æ˜¯ Intï¼Œè¿™é‡Œçš„ `+` å°±æ˜¯åŠ æ³•è¿ç®—ï¼Œå¯¹åº”å…¶ä¸­ä¸€ç§ç¼–è¯‘ç»“æœ
> -   sum æ˜¯ stringï¼Œarr æ˜¯ Arrayï¼Œi æ˜¯ Intï¼Œè¿™é‡Œçš„ `+` å°±æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå¹¶ä¸”éœ€è¦æŠŠ i è½¬æ¢ä¸º string ç±»å‹
> -   ...

> ä¸‹é¢çš„å›¾å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¹ˆç®€å•çš„ä¸€è¡Œä»£ç å¯¹åº”æœ‰ 2^4 = 16 ç§å¯èƒ½çš„ç¼–è¯‘ç»“æœ


![](https://pic1.zhimg.com/80/v2-b59e89cbf144adcc2b938db84a4fc9d8_720w.jpg)

> å‰é¢ç¬¬äºŒæ­¥çš„ Baseline compiler åšçš„å°±æ˜¯è¿™ä»¶äº‹ï¼Œæ‰€ä»¥ä¸Šé¢è¯´ç¼–è¯‘åçš„ä»£ç éœ€è¦ä½¿ç”¨ **line number** å’Œ **variable type** ä¸€èµ·åšç´¢å¼•ï¼Œå› ä¸ºä¸åŒçš„ variable type å¯¹åº”ä¸åŒçš„ç¼–è¯‘ç»“æœã€‚

> å¦‚æœä»£ç æ˜¯ **"Warm"** çš„ï¼ŒJIT çš„ä»»åŠ¡ä¹Ÿå°±åˆ°æ­¤ä¸ºæ­¢ï¼Œåé¢æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦å…ˆåˆ¤æ–­ç±»å‹ï¼Œå†ä½¿ç”¨å¯¹åº”ç±»å‹çš„ç¼–è¯‘ç»“æœå°±å¥½ã€‚

![](https://pic4.zhimg.com/80/v2-04b4d6fb3b1e55b30f04a208d206e74f_720w.jpg)


> ä½†æ˜¯ä¸Šé¢æˆ‘ä»¬è¯´ï¼Œå½“ä»£ç å˜æˆ **"hot"** çš„æ—¶å€™ï¼Œä¼šåšæ›´å¤šçš„ä¼˜åŒ–ã€‚è¿™é‡Œçš„ä¼˜åŒ–å…¶å®æŒ‡çš„å°±æ˜¯ JIT ç›´æ¥å‡è®¾ä¸€ä¸ªå‰æï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥å‡è®¾ sum æ˜¯ Intï¼Œi ä¹Ÿæ˜¯ Intï¼Œarr æ˜¯ Arrayï¼Œäºæ˜¯å°±åªç”¨ä¸€ç§ç¼–è¯‘ç»“æœå°±å¥½äº†ã€‚


![](https://pic2.zhimg.com/80/v2-37d5258e27e301f78c3c5a3e439e4edd_720w.jpg)


> å®é™…ä¸Šï¼Œåœ¨æ‰§è¡Œå‰ä¼šåšç±»å‹æ£€æŸ¥ï¼Œçœ‹æ˜¯å‡è®¾æ˜¯å¦æˆç«‹ï¼Œå¦‚æœä¸æˆç«‹æ‰§è¡Œå°±ä¼šè¢«æ‰“å› interpreter æˆ–è€… baseline compiler çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªæ“ä½œå«åš "åä¼˜åŒ– (deoptimization)"ã€‚

> å¯ä»¥çœ‹å‡ºï¼Œåªè¦å‡è®¾çš„æˆåŠŸç‡è¶³å¤Ÿé«˜ï¼Œé‚£ä¹ˆä»£ç çš„æ‰§è¡Œé€Ÿåº¦å°±ä¼šå¿«ã€‚ä½†æ˜¯å¦‚æœå‡è®¾çš„æˆåŠŸç‡å¾ˆä½ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´æ¯”æ²¡æœ‰ä»»ä½•ä¼˜åŒ–çš„æ—¶å€™è¿˜è¦æ…¢ï¼ˆå› ä¸ºè¦ç»å† optimize => deoptimize çš„è¿‡ç¨‹ï¼‰

![](https://pic3.zhimg.com/80/v2-3d59f5542434ae6d07e4223fb7e32fce_720w.jpg)

è¿™é‡Œå°±å¼•ç”³å‡ºä¸¤ä¸ªé—®é¢˜ï¼Œ

1.  å¦‚ä½•åšåˆç†çš„å‡è®¾ï¼Ÿ
2.  å‡è®¾å¤±è´¥ç‡å¾ˆé«˜çš„æ—¶å€™æ€ä¹ˆå¤„ç†ï¼Ÿ

è¿™é‡Œä½œè€…éƒ½æœ‰åšè§£ç­”ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿™ä¸æ˜¯é‡ç‚¹æˆ‘å°±ç›´æ¥æŠŠå›ç­” copy è¿‡æ¥å¥½äº†

> Answer 1: The optimizing compiler **uses the information the monitor has gathered by watching code execution to make these judgments**. If something has been true for all previous passes through a loop, it assumes it will continue to be true.  
>   
> Answer 2: Most browsers have **added limits to break out of these optimization/deoptimization cycles** when they happen. If the JIT has made more than, say, 10 attempts at optimizing and keeps having to throw it out, it will just stop trying

## è¤‡ç¿’


---
Status: #ğŸŒ± 
Tags:
[[JavaScript]]
Links:
References:

[[@naihuJavaScriptBianYiJIT]]
[[@linclarkCrashCourseJustintime]]
[[@JSYinQingYiJSZhongDeJITYuJiBenZhiXingLuoJi]]