
## æè¿°

### æ¡ˆä¾‹1 
å¼•ç”¨[[@0xbooShiMeShiWenTiYiJiRuHeJieJue]]æ‰€æè¿°ï¼š
> `N+1`Â æ˜¯ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰å…³è”æ•°æ®è¯»å–ä¸­å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜ã€‚

> åœ¨ä»‹ç»ä»€ä¹ˆæ˜¯`N+1`é—®é¢˜ä¹‹å‰ï¼Œé¦–å…ˆæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š
å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªç”¨æˆ·è¡¨ï¼ˆUserï¼‰å’Œä¸€ä¸ªä½™é¢è¡¨ï¼ˆBalanceï¼‰ï¼Œè¿™ä¸¤ä¸ªè¡¨é€šè¿‡`user_id`è¿›è¡Œå…³è”ã€‚ç°åœ¨æœ‰ä¸€ä¸ªéœ€æ±‚æ˜¯**æŸ¥è¯¢å¹´é¾„å¤§äº18å²çš„ç”¨æˆ·ï¼Œä»¥åŠç”¨æˆ·å„è‡ªçš„ä½™é¢**ã€‚

> è¿™ä¸ªé—®é¢˜å¹¶ä¸éš¾ï¼Œä½†å¯¹äºæ–°æ‰‹è€Œè¨€ï¼Œå¯èƒ½å¸¸å¸¸ä¼šçŠ¯çš„ä¸€ä¸ªé”™è¯¯å°±æ˜¯åœ¨å¾ªç¯ä¸­è¿›è¡ŒæŸ¥è¯¢ã€‚

```
$users = User::where("age", ">", 18)->select();
foreach($users as $user){
  $balance = User::getFieldByUserId($user->user_id, "balance");
  $user['balance'] = $balance;
}
```

> è¿™æ ·åšæ˜¯éå¸¸ç³Ÿç³•çš„ï¼Œæ•°æ®é‡å°è¿˜å°‘ï¼Œåœ¨æ•°æ®é‡è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œæ˜¯éå¸¸æ¶ˆè€—æ•°æ®åº“æ€§èƒ½çš„ã€‚é€šè¿‡Mysql æŸ¥è¯¢æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°æŸ¥è¯¢ç”¨æˆ·è¡¨æ˜¯ä¸€æ¬¡ï¼Œå› ä¸ºæœ‰å››ä¸ªç¬¦åˆè¯¥æ¡ä»¶çš„ç”¨æˆ·ï¼ŒæŸ¥è¯¢ç”¨æˆ·è¡¨å…³è”çš„ä½™é¢è¡¨æ˜¯å››æ¬¡ã€‚

![](https://segmentfault.com/img/remote/1460000039421846)

> `N+1`é—®é¢˜å°±æ˜¯è¿™æ ·äº§ç”Ÿçš„ï¼šæŸ¥è¯¢ä¸»è¡¨æ˜¯ä¸€æ¬¡ï¼ŒæŸ¥è¯¢å‡ºN æ¡è®°å½•ï¼Œæ ¹æ®è¿™N æ¡è®°å½•ï¼ŒæŸ¥è¯¢å…³è”çš„å‰¯ï¼ˆä»ï¼‰è¡¨ï¼Œå…±éœ€è¦N æ¬¡ã€‚æ‰€ä»¥ï¼Œåº”è¯¥å«`1+N`Â é—®é¢˜æ›´åˆé€‚ä¸€äº›ã€‚

> å…¶å®ï¼Œå¦‚æœç¨å¾®äº†è§£ä¸€ç‚¹SQLï¼Œæ ¹æœ¬ä¸ç”¨è¿™ä¹ˆéº»çƒ¦ï¼Œç›´æ¥ä½¿ç”¨`IN`Â ä¸€æ¬¡å°±æå®šäº†ã€‚å¯¹äºè¿™ç±»é—®é¢˜ï¼ŒORM å…¶å®ä¸ºæˆ‘ä»¬æä¾›äº†ç›¸åº”çš„æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯ä½¿ç”¨ã€é¢„åŠ è½½åŠŸèƒ½ã€

é‡é»ï¼š
- N + 1  Queri

### æ¡ˆä¾‹2
å¼•ç”¨[[@huyangKePuWenShiMeShiORMZhongDeNZhiHu]]æ‰€æè¿°
> æ¥ä¸‹æ¥æˆ‘ä»¬æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œå±•ç¤ºä¸€ä¸ªæ–‡ç« åˆ—è¡¨é¡µï¼Œåˆ—è¡¨é¡µä¸Šå±•ç¤ºçš„ä¿¡æ¯åŒ…æ‹¬ï¼šæ–‡ç« æ ‡é¢˜ï¼Œæ–‡ç« ä½œè€…åç§°ã€‚å°±è¿™ä¸¤ä¸ªå­—æ®µï¼Œä¹Ÿä¸éœ€è¦åˆ†é¡µã€‚

> æˆ‘ä»¬è¦æŸ¥è¯¢å‡ºè¿™æ ·çš„æ•°æ®è¦æ€ä¹ˆåšå‘¢ã€‚åœ¨ORMçš„ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬ç›´è§‚çš„åšæ³•æ˜¯è¿™æ ·:

```text
posts = Post.objects.all()  #  è·å–æ‰€æœ‰çš„æ–‡ç« æ•°æ®ï¼Œæ³¨æ„æ­¤æ—¶ä¸ä¼šæ‰§è¡Œsqlè¯­å¥  by the5fire
result = []
for post in posts:   # æ­¤æ—¶ä¼šæ‰§è¡Œselect * from postçš„æŸ¥è¯¢
    result.append({
        'title': post.title,
        'owner': post.owner.name,  # æ­¤æ—¶ä¼šæ‰§è¡Œ  select * from user where user_id = <post.user_id>
    })
```

> å†™åˆ°è¿™å°±æ˜ç™½äº†å§ã€‚æ¯æ¬¡å¾ªç¯éƒ½è¦æŸ¥ä¸€ä¸‹userè¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ˜¯10æ¡è®°å½•ï¼Œé‚£ä¹ˆæœ€ç»ˆæˆ‘éœ€è¦æ‰§è¡Œçš„æŸ¥è¯¢è¯­å¥å°±æ˜¯10 + 1 = 11æ¡è¯­å¥ã€‚å¦‚æœæˆ‘ç¬¬ä¸€æ¬¡æŸ¥è¯¢å‡ºæ¥çš„æ˜¯Næ¡è®°å½•ï¼Œé‚£ä¹ˆæœ€ç»ˆéœ€è¦æ‰§è¡Œçš„sqlè¯­å¥å°±æ˜¯N+1æ¬¡ã€‚

> è¿™å°±æ˜¯N+1çš„é—®é¢˜ã€‚

> ä½†æ˜¯å¦‚æœæ‡‚SQLçš„è¯ï¼Œå°±çŸ¥é“ï¼Œå…¶å®è¿™å°±æ˜¯ä¸€ä¸ªç®€å•çš„JOINè¯­å¥ã€‚ä¸€æ¡è¯­å¥å°±èƒ½æŸ¥å‡ºæ‰€æœ‰çš„æ•°æ®ï¼Œæä»€ä¹ˆN+1.

```text
SELECT t1.title, t2.name from post as t1 INNER JOIN user as t2 ON t2.id = t1.owner_id;
```

### ç‚ºä½•è¡ç”Ÿï¼Ÿ


1. åŸæœ¬é æœŸï¼š ç•¶å‘è³‡æ–™åº«ç™¼é€ä¸€ç­†Queryä¾†ç´¢è¦ç‰¹å®šé›†åˆçš„Nç­†ç´€éŒ„ï¼Œé‚£éº¼å¯¦éš›è³‡æ–™åº«æ”¶åˆ°çš„Queryå°±ä¸€å€‹
2. å¯¦éš›æƒ…æ³ï¼šç•¶å‘è³‡æ–™åº«ç™¼é€ä¸€ç­†Queryä¾†ç´¢è¦ç‰¹å®šé›†åˆçš„Nç­†ç´€éŒ„ï¼Œé‚£éº¼æœƒå› æ²’äº‹å…ˆç´€éŒ„èˆ‡ç‰¹å®šé›†åˆç›¸é—œé€£çš„é›†åˆè€Œç™¼é€N+1ç­†Queriesä¾†å¯¦ç¾


é æœŸæœƒæœ‰çš„å¯¦ç¾ï¼šç•¶å‘è³‡æ–™åº«ç™¼é€ä¸€ç­†Queryä¾†ç´¢è¦ç‰¹å®šé›†åˆAçš„Nç­†ç´€éŒ„ï¼Œé‚£éº¼æœƒé æœŸç³»çµ±æœƒäº‹å…ˆå‘è³‡æ–™åº«ç´¢è¦èˆ‡ç‰¹å®šé›†åˆç›¸é—œé€£çš„è¡¨æ ¼é›†åˆBä¸¦è¨˜éŒ„ä¸‹ä¾†ï¼Œæ¥è‘—è®“ç‰¹å®šé›†åˆAçš„æ¯ä¸€ç­†ç´€éŒ„(ç¸½æ•¸ç‚ºNç­†)éƒ½å»å¾è¡¨æ ¼é›†åˆBæ‰¾åˆ°ç›¸é—œé€£çš„ç´€éŒ„ï¼Œæ¯”å¦‚ï¼š

ç‰¹å®šé›†åˆAç‚ºç”¢å“è¡¨æ ¼ï¼Œè€Œèˆ‡ç‰¹å®šé›†åˆAç›¸é—œé€£çš„è¡¨æ ¼é›†åˆBæ˜¯åº«å­˜é‡ï¼Œé‚£éº¼ç³»çµ±å°±æœƒå…ˆå‘è³‡æ–™åº«ç´¢è¦åº«å­˜é‡ä¾†ç´€éŒ„ï¼Œç„¶å¾Œè®“ç‰¹å®šé›†åˆAçš„æ¯ç­†ç´€éŒ„é€éå¤–éµä¾†å¾åº«å­˜é‡æ‰¾åˆ°ç›¸é—œé€£çš„ç´€éŒ„


å¯¦éš›æœƒæœ‰çš„å¯¦ç¾ï¼šç•¶å‘è³‡æ–™åº«ç™¼é€ä¸€ç­†Query ä¾†ç´¢è¦ç‰¹å®šé›†åˆAçš„Nç­†ç´€éŒ„ï¼Œå¯¦éš›ä¸Šç³»çµ±ä¸¦ä¸æœƒäº‹å…ˆç´€éŒ„èˆ‡ç‰¹å®šé›†åˆAç›¸é—œé€£çš„è¡¨æ ¼é›†åˆBï¼Œé‚£éº¼ç‚ºæ­¤ï¼Œç‰¹å®šé›†åˆAçš„æ¯ä¸€ç­†ç´€éŒ„éƒ½å¿…é ˆå‘è³‡æ–™åº«ç™¼é€ä¸€ç­†Query ä¾†ç´¢è¦è¡¨æ ¼é›†åˆBï¼Œæ¥è‘—å¾è¡¨æ ¼é›†åˆBæ‰¾åˆ°ç›¸é—œé€£çš„ç´€éŒ„ã€‚

ç‚ºæ­¤ç¸½å…±çš„Queryæ•¸æœƒæ˜¯å¦‚ä¸‹ï¼Œ1æ˜¯æŒ‡åŸæœ¬å‘è³‡æ–™åº«ç´¢è¦ç‰¹å®šé›†åˆAå€‹Nç­†ç´€éŒ„ä¹‹Queryï¼Œè€ŒNå€‹Queriesæ˜¯æŒ‡ç‰¹å®šé›†åˆAçš„æ¯ä¸€ç­†æ‰€ç™¼å‡ºé¡å¤–çš„ä¸€ç­†Queryï¼Œè€Œé€™Queryæ˜¯å‘è³‡æ–™åº«ç´¢è¦è‘—è¡¨æ ¼é›†åˆBã€‚
```
1 + N å€‹Queries
```

### å¯¦å‹™å±¤é¢ï¼šç‚ºä½•è¦ç‰¹åˆ¥æèµ·é€™å•é¡Œ
N + 1 Queries Problem æè¿°è‘—é¡å¤–ç”¢å‡ºçš„Queryï¼Œè€ŒQueryè¶Šå¤šï¼Œè³‡æ–™åº«è² æ“”å°±è¶Šé‡ï¼Œæ‰€ä»¥å¯¦å‹™ä¸Šæåˆ°å®ƒä¹ƒæ˜¯å› ç‚ºå®ƒæ˜¯åœ¨å¢åŠ è³‡æ–™åº«çš„ä¸å¿…è¦è™•ç†è² æ“”å‰æä¸‹ï¼Œä¾†å¯¦ç¾ä¸»è¦çš„Query ã€‚

### å¸¸è¦‹çš„èµ·å› 
ä¸€èˆ¬ä¾†èªªï¼ŒSQLå®˜æ–¹æä¾›çš„èªæ³•éƒ½æœƒç‰¹åˆ¥äº‹å…ˆç´€éŒ„ç›¸é—œé€£çš„è¡¨æ ¼ï¼Œä½†è‹¥è€ƒæ…®ORMéœ€è¦å¾æ‡‰ç”¨ç¨‹å¼å±¤é¢ä¾†è½‰æ›SQLèªæ³•çš„è©±ï¼Œå°±ä¸ä¸€å®šèƒ½å¤ ç‰¹åˆ¥é—œæ³¨é€™å•é¡Œï¼Œå› æ­¤å¸¸è¦‹çš„å•é¡Œä¹ƒæ˜¯å› ç‚º **ORM æ˜¯å¦æœƒäº‹å…ˆå„²å­˜ç›¸é—œé€£çš„è¡¨æ ¼ä¾†åšè™•ç†**


## è¤‡ç¿’
#ğŸ§  Question :: ->->-> ``

---
Status: #ğŸŒ± 
Tags:
[[Database]] - [[ORM]]
Links:
References:
[[@0xbooShiMeShiWenTiYiJiRuHeJieJue]]
[[@huyangKePuWenShiMeShiORMZhongDeNZhiHu]]