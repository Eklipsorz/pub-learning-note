## æè¿°
[[@reacttaiwanReactjsTwMeetup2022]]
> Reusable state - React 18 çš„ useEffect åœ¨ mount æ™‚ç‚ºä½•æœƒåŸ·è¡Œå…©æ¬¡ï¼Ÿ
> https://codesandbox.io/s/heuristic-beaver-ufgfef?file=/src/App.js
> React é è¨ˆåœ¨æœªä¾†æ·»åŠ éœ€å¤šæ–°åŠŸèƒ½å€‘è¦æœ‰ä¸€å€‹å…±åŒå‰æç´„æŸ
> 	- Component å¿…é ˆè¦è¨­è¨ˆå¾—æœ‰è¶³å¤ çš„å½ˆæ€§ä¾†å¤šæ¬¡ mount & unmount ä¹Ÿä¸æœƒå£æ‰

> Offscreen API
> 	 - è®“ React å¯ä»¥åœ¨ UI åˆ‡æ›æ™‚ä¿ç•™component çš„local state ä»¥åŠå°æ‡‰çš„çœŸå¯¦DOM elementsï¼Œåƒæ˜¯æŠŠä»–å€‘æš«æ™‚éš±è—èµ·ä¾†è€Œä¸æ˜¯çœŸçš„ç§»é™¤å®ƒå€‘
> 	 - ç•¶é€™å€‹componentæœ‰å†æ¬¡é¡¯ç¤ºçš„éœ€æ±‚æ™‚ï¼Œå°±èƒ½ä»¥ä¹‹å‰ç•™ä¸‹ä¾†çš„stateç‹€æ…‹å†æ¬¡mount
> 	 - èˆ‰ä¾‹åœ¨ä¸åŒçš„tabåˆ‡æ›UIï¼Œtab A åˆ‡æ›è‡³ tab Bï¼Œtab Açš„å°æ‡‰ç•«é¢å¿…é ˆå¾—é‡æ–°ç²å–å°æ‡‰çš„local stateå’Œé‡æ–°æ¸²æŸ“

> strict mode + dev env æ™‚æœƒè‡ªå‹•mount å…©æ¬¡ï¼Œæ˜¯åœ¨æ¨¡æ“¬ mount => unmount => mount çš„éç¨‹
> å¹«åŠ©é–‹ç™¼è€…æª¢æŸ¥effect çš„è¨­è¨ˆæ˜¯å¦æ»¿è¶³é€™å€‹å½ˆæ€§çš„éœ€æ±‚


[[@zhuanjiabrickspertYiPianDaiGeiNiReact18]]
> # æ›´æ–°`ä¸¥æ ¼æ¨¡å¼`

> åœ¨æœªæ¥ï¼ŒReact æƒ³è¦åœ¨ä¿å­˜ `state` çš„åŒæ—¶å¯ä»¥æ·»åŠ å’Œç§»é™¤ UI å—ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé¢æ¿ä¸Šï¼Œç”¨æˆ·ä½¿ç”¨ `tab`å¯ä»¥å¿«é€Ÿåœ°ä» `A` é¢æ¿åˆ‡æ¢åˆ° `B` é¢æ¿ï¼Œè€Œæˆ‘å¸Œæœ›åœ¨åˆ‡æ¢åˆ° `B` é¢æ¿çš„æ—¶å€™ï¼Œå¯ä»¥ä¿ç•™ `A` é¢æ¿çš„ `state`ï¼Œè¿™æ ·åœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæˆ‘å°±å¯ä»¥å³æ—¶åœ°å»æ¸²æŸ“ä¹‹å‰çš„é‚£ä¸ªé¡µé¢ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼ŒReact åœ¨ `unmount` å’Œ `mount` æ—¶ä½¿ç”¨çš„æ˜¯ç›¸åŒçš„ç»„ä»¶ `state`ã€‚

> è¿™æ ·çš„ç‰¹æ€§å¯ä»¥æé«˜ React çš„æ€§èƒ½ï¼Œä½†æ˜¯è¿™åŒæ ·è¦æ±‚ç»„ä»¶å¯¹äºé¢‘ç¹çš„ `mount` å’Œ `unmount` äº§ç”Ÿçš„`effects` æœ‰èƒ½å¤Ÿçµæ´»å¤„ç†çš„èƒ½åŠ›ã€‚å¤§å¤šæ•°çš„ `effects` éƒ½ä¸ä¼šé€ æˆä»»ä½•æ”¹å˜å’Œå½±å“ï¼Œä½†æ˜¯æœ‰ä¸€äº› `effects` ä¼šè®¤ä¸ºç»„ä»¶åªä¼šè¢« `mount` å’Œé”€æ¯ä¸€æ¬¡ã€‚

> ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒReact 18 å¯¹äº `Strict Mode` ä»‹ç»äº†ä¸€ç§ `development-only` è¿™ç§æ£€æŸ¥æœºåˆ¶ã€‚è¿™ç§æ£€æŸ¥ä¼šè‡ªåŠ¨ `mount` æˆ–è€… `unmount` æ¯ä¸€ä¸ªç»„ä»¶ï¼Œæ— è®ºæ˜¯ç»„ä»¶ç¬¬ä¸€æ¬¡è¢« `mount`ï¼Œè¿˜æ˜¯ç»„ä»¶å·²ç»è¢« `mount` è¿‡ä¸€æ¬¡ï¼Œä¿å­˜äº†ä¹‹å‰çš„ `state`ï¼Œä»è€Œç¬¬äºŒæ¬¡è¢« `mount`ã€‚

> åœ¨è¿™æ¬¡æ”¹å˜ä¹‹å‰ï¼ŒReact ä¼š `mount` ç»„ä»¶å¹¶åˆ›å»ºä¸‹é¢è¿™ç§ `effects`ã€‚

```javascript
* React mounts the component.
    * Layout effects are created.
    * Effect effects are created.
```
  

åœ¨ React 18 çš„ `Strict Mode` ä¸­ï¼ŒReact ä¼šåœ¨ `development mode` ä¸­æ¨¡æ‹Ÿ `unmount` å’Œ `remount`ã€‚

```javascript
* React mounts the component.
    * Layout effects are created.
    * Effect effects are created.
* React simulates unmounting the component.
    * Layout effects are destroyed.
    * Effects are destroyed.
* React simulates mounting the component with the previous state.
    * Layout effect setup code runs
    * Effect setup code runs
```


### é‡å°æ”¯æ´Offscreen APIçš„Componentæ‰€åšçš„æª¢æ¸¬


React æœªä¾†æœƒæœè‘—éµå®ˆä»¥ä¸‹è¦å‰‡ä¾†æ·»åŠ æ–°åŠŸèƒ½ï¼š
	- Component åœ¨é¢å°å¤šæ¬¡çš„ mount => unmount => mount çš„å¾ªç’°ä¸­ä»ç„¶ä¿æœ‰åŸæœ‰å…ƒä»¶çš„æ¥­å‹™é‚è¼¯åŠŸèƒ½å’Œæ¸²æŸ“å…§å®¹
ç›®å‰å·²çŸ¥æœƒèˆ‡é€™è¦å‰‡èµ·è¡çªçš„èªæ³•ç‚ºï¼š
	- ç•¶ä½¿ç”¨Offscreen APIé–‹ç™¼Componentæ™‚ï¼ŒComponentä¸Šçš„å¤§éƒ¨åˆ†effectså¯¦ç¾æœƒé¢å°åŒå€‹å…ƒä»¶çš„mount->unmount->mountä¸‹ä¿ç•™å…¶åŠŸèƒ½ï¼Œä½†å°‘éƒ¨ä»½effectså¯¦ç¾å‰‡æœƒæ˜¯èªç‚ºå…ƒä»¶åªæœƒæœ‰ä¸€æ¬¡mount->unmountçš„ï¼Œè€Œå°è‡´åŒå€‹å…ƒä»¶åªè¦unmountå¾Œå°±éŠ·æ¯€effectï¼Œæ¥è‘—å†æ¬¡ä»¥ç·©å­˜ä¾†mountçš„æ™‚å€™å°±ç„¡æ³•æ­£å¸¸ä½¿ç”¨ã€‚
æ–°åŠŸèƒ½é è¨ˆæœƒæœ‰ï¼š
	- Offscreen API
é¢å°é€™è¦å‰‡æœƒåœ¨é–‹ç™¼éšæ®µä¸­å¯ä»¥æ·»åŠ React.StrictModeå…ƒä»¶é€²è¡Œç›¸é—œæª¢æ¸¬
	- ç•¶åœ¨React.StrictModeå…ƒä»¶ä¸‹åŠ å…¥æ–°å…ƒä»¶ A ä¸¦åšå®Œmountingæ™‚ï¼ŒReact.StrictModeæœƒæ›¿è©²mountingçš„å…ƒä»¶ Aæš«å­˜å…¶ç‹€æ…‹å’Œå¯¦éš›DOMçµæ§‹ï¼Œç„¶å¾Œå†è‡ªè¡Œunmounting æ–°å…ƒä»¶ Aï¼Œç„¶å¾Œå†ä»¥æš«å­˜å…§å®¹ä¾†å†æ¬¡é€²è¡Œå…¶å…ƒä»¶Açš„mountingã€‚
	- éç¨‹ä¸­æœƒæª¢æ¸¬å…¶å…ƒä»¶ä¸Šçš„effectæ˜¯å¦æ­£å¸¸é‹ä½œ


#### Offscreen APIæ˜¯ä»€éº¼

é‡é»ï¼š
- Offscreen API æ˜¯æŒ‡åœ¨è¦åˆ‡æ›å¦ä¸€å€‹ç•«é¢Bå‰ï¼Œèƒ½å¤ æš«å­˜ç›®å‰æ‰€é¡¯ç¤ºçš„ç•«é¢Aï¼Œä¸¦å°‡å…¶ç•«é¢ç§»å‹•è‡³äººå€‘çœ‹ä¸åˆ°çš„åœ°æ–¹ï¼Œä»¥æ–¹ä¾¿æ¸²æŸ“å…¶ä»–ç•«é¢Bï¼Œç­‰åˆ°è¦æ¸²æŸ“ç•«é¢Aæ™‚ï¼Œå°±å°‡ä»¥ç•«é¢Açš„æš«å­˜å…§å®¹ä¾†å¿«é€Ÿæ¸²æŸ“
- å…·é«”æœƒæ˜¯
	- åœ¨è¦åˆ‡æ›å¦ä¸€å€‹ç•«é¢Bå‰ï¼Œå°±æš«å­˜è®“ç›®å‰ç•«é¢Aä¸Šçš„å…ƒä»¶å®ƒå€‘å„è‡ªçš„ç‹€æ…‹ä»¥åŠä»–å€‘æ‰€å°æ‡‰çš„å¯¦éš›DOMçµæ§‹
	- å¾ç›®å‰DOM Treeé‚£ unmount ç›®å‰ç•«é¢Açš„å…ƒä»¶æ‰€å°æ‡‰çš„å¯¦éš›DOM çµæ§‹
	- mount ç•«é¢Bä¸Šçš„å…ƒä»¶æ‰€å°æ‡‰çš„å¯¦éš›DOMçµæ§‹è‡³ç›®å‰DOM Tree
	- ç­‰åˆ°ä¸‹ä¸€æ¬¡åˆ‡å›ç•«é¢Aæ™‚ï¼Œå°±é€éæš«å­˜çš„ç‹€æ…‹å’Œç¾æœ‰å°æ‡‰DOMçµæ§‹å¿«é€Ÿåœ¨DOMçµæ§‹å†mountä¸€éç•«é¢Aä¸Šçš„å…ƒä»¶ï¼Œä»¥ç¯€çœå¾—åˆ°ç‹€æ…‹å’Œå°æ‡‰DOMçµæ§‹çš„æ™‚é–“
- é©ç”¨å ´æ™¯ç‚ºï¼š
	- å¤šå€‹tabå…±äº«åŒä¸€å€‹é¡¯ç¤ºå…ƒä»¶ï¼Œä¸¦è—‰ç”±é»æ“Šç‰¹å®štabAä¾†mounting å°æ‡‰å…ƒä»¶Aï¼Œç„¶å¾Œåˆæƒ³é»æ“Šå¦ä¸€å€‹tab Bçš„é‚£éº¼å°±unmounting å°æ‡‰å…ƒä»¶Aä»¥åŠmounting å°æ‡‰å…ƒä»¶Bï¼Œæ¥è‘—åˆé»å›tab Aå°±åˆå¾—unmounting å°æ‡‰å…ƒä»¶Bå’Œmounting å°æ‡‰å…ƒä»¶A
	- å¤šå€‹å…ƒä»¶Aå…±äº«è‘—åŒä¸€å€‹ç”¨ä¾†é¡¯ç¤ºå…¶å…ƒä»¶å°æ‡‰ç•«é¢çš„å…ƒä»¶Bï¼šæ¯å€‹å…ƒä»¶Aéƒ½æœ‰å°æ‡‰çš„æ¸²æŸ“å…§å®¹ï¼Œä½†åªæœƒæœ‰ä¸€å€‹å…ƒä»¶Açš„å°æ‡‰æ¸²æŸ“å…§å®¹å‘ˆç¾åœ¨å…ƒä»¶Bä¸Šã€‚
	- è‹¥æ˜¯å¯¦ç¾å¤šå€‹å…ƒä»¶éƒ½å„æœ‰ä¸€å€‹é¡¯ç¤ºå…ƒä»¶ï¼Œé‚£éº¼å°±æœè‘—å„ªåŒ–ç¶²é å°æ–¼ç€è¦½å™¨çš„æ•ˆèƒ½
å¥½è™•ç‚ºï¼š
	- åœ¨mount=>unmountçš„å¾ªç’°å ´æ™¯ï¼Œè—‰ç”±åˆ‡æ›å‰çš„ç·©å­˜ä¾†æé«˜ç•«é¢åˆ‡æ›çš„æ•ˆç‡
	


### offscreen å‘½åç·£ç”±

off-screen
> off the screen, or above, below, or at the side of the screen, so that the people who are watching cannot see 

é‡é»ï¼š
- offscreen æ˜¯æŒ‡å°‡è¢å¹•çš„ç•«é¢ç§»å‹•è‡³äººå€‘çœ‹ä¸åˆ°çš„åœ°æ–¹
## è¤‡ç¿’
#ğŸ§  offscreen å‘½åç·£ç”±æ˜¯ä»€éº¼ ->->-> `è¢å¹•çš„ç•«é¢ç§»å‹•è‡³äººå€‘çœ‹ä¸åˆ°çš„åœ°æ–¹`

#ğŸ§  Reactï¼šOffscreen APIæ˜¯ä»€éº¼æ¨£çš„æ¦‚å¿µï¼Ÿ  ->->-> `æŒ‡åœ¨è¦åˆ‡æ›å¦ä¸€å€‹ç•«é¢Bå‰ï¼Œèƒ½å¤ æš«å­˜ç›®å‰æ‰€é¡¯ç¤ºçš„ç•«é¢Aï¼Œä¸¦å°‡å…¶ç•«é¢ç§»å‹•è‡³äººå€‘çœ‹ä¸åˆ°çš„åœ°æ–¹ï¼Œä»¥æ–¹ä¾¿æ¸²æŸ“å…¶ä»–ç•«é¢Bï¼Œç­‰åˆ°è¦æ¸²æŸ“ç•«é¢Aæ™‚ï¼Œå°±å°‡ä»¥ç•«é¢Açš„æš«å­˜å…§å®¹ä¾†å¿«é€Ÿæ¸²æŸ“`

#ğŸ§  Reactï¼šOffscreen API å…·é«”å¦‚ä½•å¯¦ç¾å…¶æ¦‚å¿µï¼Ÿ(è«‹ä»¥ç•«é¢Açš„å…ƒä»¶å’Œç•«é¢Bçš„å…ƒä»¶ä¾†èˆ‰ä¾‹) ->->-> `åœ¨è¦åˆ‡æ›å¦ä¸€å€‹ç•«é¢Bå‰ï¼Œå°±æš«å­˜è®“ç›®å‰ç•«é¢Aä¸Šçš„å…ƒä»¶å®ƒå€‘å„è‡ªçš„ç‹€æ…‹ä»¥åŠä»–å€‘æ‰€å°æ‡‰çš„å¯¦éš›DOMçµæ§‹ã€å¾ç›®å‰DOM Treeé‚£ unmount ç›®å‰ç•«é¢Açš„å…ƒä»¶æ‰€å°æ‡‰çš„å¯¦éš›DOM çµæ§‹ã€mount ç•«é¢Bä¸Šçš„å…ƒä»¶æ‰€å°æ‡‰çš„å¯¦éš›DOMçµæ§‹è‡³ç›®å‰DOM Treeã€ç­‰åˆ°ä¸‹ä¸€æ¬¡åˆ‡å›ç•«é¢Aæ™‚ï¼Œå°±é€éæš«å­˜çš„ç‹€æ…‹å’Œç¾æœ‰å°æ‡‰DOMçµæ§‹å¿«é€Ÿåœ¨DOMçµæ§‹å†mountä¸€éç•«é¢Aä¸Šçš„å…ƒä»¶ï¼Œä»¥ç¯€çœå¾—åˆ°ç‹€æ…‹å’Œå°æ‡‰DOMçµæ§‹çš„æ™‚é–“`

#ğŸ§  Reactï¼šOffscreen API  èƒ½å¸¶ä¾†ä»€éº¼å¥½è™•ï¼Ÿ ->->-> `åœ¨mount=>unmountçš„å¾ªç’°å ´æ™¯ï¼Œè—‰ç”±åˆ‡æ›å‰çš„ç·©å­˜ä¾†æé«˜ç•«é¢åˆ‡æ›çš„æ•ˆç‡`

#ğŸ§  Reactï¼šOffscreen API  æœƒæ‡‰ç”¨ä»€éº¼å ´æ™¯ ->->-> `å¤šå€‹tabå…±äº«åŒä¸€å€‹é¡¯ç¤ºå…ƒä»¶ï¼Œä¸¦è—‰ç”±é»æ“Šç‰¹å®štabAä¾†mounting å°æ‡‰å…ƒä»¶Aï¼Œç„¶å¾Œåˆæƒ³é»æ“Šå¦ä¸€å€‹tab Bçš„é‚£éº¼å°±unmounting å°æ‡‰å…ƒä»¶Aä»¥åŠmounting å°æ‡‰å…ƒä»¶Bï¼Œæ¥è‘—åˆé»å›tab Aå°±åˆå¾—unmounting å°æ‡‰å…ƒä»¶Bå’Œmounting å°æ‡‰å…ƒä»¶Aã€å¤šå€‹å…ƒä»¶Aå…±äº«è‘—åŒä¸€å€‹ç”¨ä¾†é¡¯ç¤ºå…¶å…ƒä»¶å°æ‡‰ç•«é¢çš„å…ƒä»¶Bï¼šæ¯å€‹å…ƒä»¶Aéƒ½æœ‰å°æ‡‰çš„æ¸²æŸ“å…§å®¹ï¼Œä½†åªæœƒæœ‰ä¸€å€‹å…ƒä»¶Açš„å°æ‡‰æ¸²æŸ“å…§å®¹å‘ˆç¾åœ¨å…ƒä»¶Bä¸Šã€‚`

#ğŸ§   Reactï¼šOffscreen API æ‡‰ç”¨è‡³å¤šå€‹å…ƒä»¶éƒ½å„æœ‰ä¸€å€‹é¡¯ç¤ºå…ƒä»¶ï¼Œé‚£éº¼æœƒå¸¶ä¾†ä»€éº¼å¥½è™•ï¼Ÿ ->->-> `é‚£éº¼å°±æœè‘—å„ªåŒ–ç¶²é å°æ–¼ç€è¦½å™¨çš„æ•ˆèƒ½`

#ğŸ§  Reactï¼šç‚ºäº†èƒ½æ·»åŠ Offscreen API ä¾†çµ¦Componentæ”¯æ´ï¼Œå¿…é ˆè¦è®“Componenté–‹ç™¼ä¸Šéµå®ˆä»€éº¼ï¼Ÿ  ->->-> `Component åœ¨é¢å°å¤šæ¬¡çš„ mount => unmount => mount çš„å¾ªç’°ä¸­ä»ç„¶ä¿æœ‰åŸæœ‰å…ƒä»¶çš„æ¥­å‹™é‚è¼¯åŠŸèƒ½å’Œæ¸²æŸ“å…§å®¹`

#ğŸ§  Reactï¼šåœ¨æ”¯æ´Offscreen APIçš„Componentä¸­ï¼Œ ç›®å‰å·²çŸ¥æœƒèˆ‡é€™è¦å‰‡èµ·è¡çªçš„èªæ³•ç‚ºä½• ->->-> `ç•¶ä½¿ç”¨Offscreen APIé–‹ç™¼Componentæ™‚ï¼ŒComponentä¸Šçš„å¤§éƒ¨åˆ†effectså¯¦ç¾æœƒé¢å°åŒå€‹å…ƒä»¶çš„mount->unmount->mountä¸‹ä¿ç•™å…¶åŠŸèƒ½ï¼Œä½†å°‘éƒ¨ä»½effectså¯¦ç¾å‰‡æœƒæ˜¯èªç‚ºå…ƒä»¶åªæœƒæœ‰ä¸€æ¬¡mount->unmountçš„ï¼Œè€Œå°è‡´åŒå€‹å…ƒä»¶åªè¦unmountå¾Œå°±éŠ·æ¯€effectï¼Œæ¥è‘—å†æ¬¡ä»¥ç·©å­˜ä¾†mountçš„æ™‚å€™å°±ç„¡æ³•æ­£å¸¸ä½¿ç”¨ã€‚`


#ğŸ§  Reactï¼šç‚ºäº†ç¢ºä¿é è¨ˆè¦æ”¯æ´Offscreen APIçš„Componentæ˜¯èƒ½å¤ æ­£å¸¸é‹è¡Œeffectså¯¦ç¾ï¼Œæ‰€ä»¥æœƒåšä»€éº¼æª¢æ¸¬ï¼Ÿ ->->-> `é–‹ç™¼éšæ®µä¸­å¯ä»¥æ·»åŠ React.StrictModeå…ƒä»¶é€²è¡Œç›¸é—œæª¢æ¸¬`

#ğŸ§  Reactï¼šç‚ºäº†ç¢ºä¿é è¨ˆè¦æ”¯æ´Offscreen APIçš„Componentæ˜¯èƒ½å¤ æ­£å¸¸é‹è¡Œeffectså¯¦ç¾ï¼ŒæœƒåšReact.StrictModeå…ƒä»¶é€²è¡Œç›¸é—œæª¢æ¸¬ï¼Œå…¶æª¢æ¸¬å…§å®¹ç‚ºï¼Ÿ ->->-> `ç•¶åœ¨React.StrictModeå…ƒä»¶ä¸‹åŠ å…¥æ–°å…ƒä»¶ A ä¸¦åšå®Œmountingæ™‚ï¼ŒReact.StrictModeæœƒæ›¿è©²mountingçš„å…ƒä»¶ Aæš«å­˜å…¶ç‹€æ…‹å’Œå¯¦éš›DOMçµæ§‹ï¼Œç„¶å¾Œå†è‡ªè¡Œunmounting æ–°å…ƒä»¶ Aï¼Œç„¶å¾Œå†ä»¥æš«å­˜å…§å®¹ä¾†å†æ¬¡é€²è¡Œå…¶å…ƒä»¶Açš„mountingã€‚ã€éç¨‹ä¸­æœƒæª¢æ¸¬å…¶å…ƒä»¶ä¸Šçš„effectæ˜¯å¦æ­£å¸¸é‹ä½œ`


---
Status: #ğŸŒ± 
Tags:
[[React]] - [[JavaScript]]
Links:
[[React.StrictMode æ˜¯ä»¥å…ƒä»¶å½¢å¼ä¾†åœ¨é–‹ç™¼éšæ®µæª¢æ¸¬å…¶å…ƒä»¶åŒ…å«çš„å…§å®¹æ˜¯å¦æœ‰æ½›åœ¨å•é¡Œ]]
References:
[[@reacttaiwanReactjsTwMeetup2022]]
[[@zhuanjiabrickspertYiPianDaiGeiNiReact18]]