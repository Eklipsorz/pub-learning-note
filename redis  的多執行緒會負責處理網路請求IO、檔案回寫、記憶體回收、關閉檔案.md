## æè¿°
[[@MianShiGuanWenRedisShiDanZhiXingXuHuanShiDuoZhiXingXu]]æ‰€æè¿°ï¼š

### ç‰ˆæœ¬3.0

> Redis 3.0 ç‰ˆæœ¬å¾Œï¼Œä¸»ç¨‹å¼ä¸­é™¤äº†ä¸»åŸ·è¡Œç·’è™•ç†ç¶²è·¯ IO å’Œå‘½ä»¤æ“ä½œå¤–ï¼Œé‚„æœ‰ 3 å€‹è¼”åŠ© BIO åŸ·è¡Œç·’ã€‚é€™ 3 å€‹ BIO åŸ·è¡Œç·’åˆ†åˆ¥è² è²¬è™•ç†ï¼Œæª”æ¡ˆé—œé–‰ã€AOF ç·©è¡è³‡æ–™é‡æ–°æ•´ç†åˆ°ç£ç¢Ÿï¼Œä»¥åŠæ¸…ç†ç‰©ä»¶é€™ä¸‰å€‹ä»»å‹™ä½‡åˆ—ï¼Œå¾è€Œé¿å…é€™äº›ä»»å‹™å°ä¸» IO åŸ·è¡Œç·’çš„å½±éŸ¿ã€‚
> Redis åœ¨å•Ÿå‹•æ™‚ï¼ŒæœƒåŒæ™‚å•Ÿå‹•é€™ä¸‰å€‹ BIO åŸ·è¡Œç·’ï¼Œä½†æ˜¯ BIO åŸ·è¡Œç·’åªæœ‰åœ¨éœ€è¦åŸ·è¡Œç›¸é—œå‹åˆ¥å¾Œè‡ºä»»å‹™æ™‚æ‰æœƒå–šé†’ï¼Œå…¶ä»–æ™‚é–“æœƒä¼‘çœ ç­‰å¾…ä»»å‹™ã€‚

![](https://i.iter01.com/images/ad6688b840c91cb804f3c2a21289d2e581484efc2c9d9c421bb9323a8299831f.png)

é‡é»ï¼š
- åœ¨Redis 3.xç‰ˆæœ¬ä¸­ï¼Œä¸»åŸ·è¡Œç·’è² è²¬è™•ç†ç¶²è·¯è«‹æ±‚IOã€è™•ç†æŒ‡ä»¤æ“ä½œ
- é™¤äº†ä¸»åŸ·è¡Œç·’ä»¥å¤–ï¼Œé‚„æœ‰ä¸‰å€‹è¼”åŠ©ç”¨çš„BIO åŸ·è¡Œç·’ä¾†è² è²¬ä»¥ä¸‹æ¥­å‹™ï¼Œé€™äº›åŸ·è¡Œç·’åªæœ‰åœ¨éœ€è¦æ™‚æ‰æœƒè¢«å–šé†’ï¼Œå¹³æ™‚éƒ½æœƒä¿æŒç¡çœ 
	- fsync åŸ·è¡Œç·’ï¼šAOF ç·©è¡è³‡æ–™é‡æ–°æ•´ç†åˆ°ç£ç¢Ÿ
	- closeåŸ·è¡Œç·’ï¼šæª”æ¡ˆé—œé–‰
	- æ¸…ç†å›æ”¶åŸ·è¡Œç·’ï¼šæ¸…ç†ç‰©ä»¶
- fsync åŸ·è¡Œç·’ã€closeåŸ·è¡Œç·’ã€æ¸…ç†å›æ”¶åŸ·è¡Œç·’æ˜¯Background I/O (BIO) ï¼Œæœƒæ–¼èƒŒæ™¯ä¸‹åŸ·è¡Œã€‚

### ç„¡å¤šåŸ·è¡Œç·’çš„redisç‰ˆæœ¬
æ ¹æ“š[[@fijismithyRedisSourceCode]]æ‰€æè¿°ï¼š
![](https://programmer.ink/images/think/50216a37090eb07355566e7e29242bbd.jpg)

é‡é»ï¼š
- å–®åŸ·è¡Œç·’ä¸‹æœƒèˆ‡å®¢æˆ¶ç«¯å»ºç«‹é€£ç·šä»¥åŠsocketä¾†æ¥æ”¶å°æ‡‰çš„æŒ‡ä»¤
- é€™äº›æŒ‡ä»¤æœƒä¾åºæ”¾åœ¨æŒ‡ä»¤ä½‡åˆ—ä¸­ï¼Œredis ä¸»è¦åŸ·è¡Œç·’æœƒå¾ä½‡åˆ—ä¸­å–å‡ºæŒ‡ä»¤åŸ·è¡Œä¸¦å°‡çµæœæ”¾å…¥ç·©è¡å€
- ç­‰åˆ°æ‰€æœ‰æŒ‡ä»¤åŸ·è¡Œå®Œç•¢å¾Œï¼Œå°±è² è²¬æŒ‰ç…§socketè³‡è¨Šå°‡æ‰€æœ‰æŒ‡ä»¤çš„çµæœå›å¯«è‡³å°æ‡‰clientç«¯

### ç‰ˆæœ¬6.0

> å¤šåŸ·è¡Œç·’æ˜¯ Redis6.0 æ¨å‡ºçš„ä¸€å€‹æ–°ç‰¹æ€§ã€‚æ­£å¦‚ä¸Šé¢æ‰€èªª Redis æ˜¯æ ¸å¿ƒåŸ·è¡Œç·’è² è²¬ç¶²è·¯ IO ï¼Œå‘½ä»¤è™•ç†ä»¥åŠå¯«è³‡æ–™åˆ°ç·©è¡ï¼Œè€Œéš¨è‘—ç¶²è·¯ç¡¬é«”çš„æ•ˆèƒ½æå‡ï¼Œå–®å€‹ä¸»åŸ·è¡Œç·’è™•ç†â½¹çµ¡è«‹æ±‚çš„é€Ÿåº¦è·Ÿä¸ä¸Šåº•å±¤â½¹çµ¡ç¡¬é«”çš„é€Ÿåº¦ï¼Œå°è‡´ç¶²è·¯ IO çš„è™•ç†æˆç‚ºäº† Redis çš„æ•ˆèƒ½ç“¶é ¸ã€‚

> è€Œ Redis6.0 å°±æ˜¯å¾å–®åŸ·è¡Œç·’è™•ç†ç¶²è·¯è«‹æ±‚åˆ°å¤šåŸ·è¡Œç·’è™•ç†ï¼Œé€šéå¤šå€‹ IO åŸ·è¡Œç·’ä¸¦â¾è™•ç†ç¶²è·¯æ“ä½œæå‡ä¾‹é …çš„æ•´é«”è™•ç†æ•ˆèƒ½ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å°æ–¼è®€å¯«å‘½ä»¤ï¼ŒRedis ä»ç„¶ä½¿â½¤å–®åŸ·è¡Œç·’ä¾†è™•ç†ï¼Œé€™æ˜¯å› ç‚ºç¹¼çºŒä½¿â½¤å–®åŸ·è¡Œç·’åŸ·è¡Œå‘½ä»¤æ“ä½œï¼Œå°±ä¸â½¤ç‚ºäº†ä¿è­‰ Lua æŒ‡ä»¤ç¢¼ã€äº‹å‹™çš„åŸâ¼¦æ€§ï¼Œé¡å¤–é–‹ç™¼å¤šåŸ·è¡Œç·’äº’æ–¥æ©Ÿåˆ¶äº†ã€‚


![](https://i.iter01.com/images/366286b2a68f20c755c2692895d9ff3a58719c78e75a4adf43ae2be2f6841850.png)


> å…¨éƒ¨æµç¨‹åˆ†ç‚ºä»¥ä¸‹ 4 éšæ®µï¼š

> **éšæ®µä¸€ï¼šæœå‹™ç«¯å’Œå®¢â¼¾ç«¯å»ºç«‹ Socket é€£ç·šï¼Œä¸¦åˆ†é…è™•ç†åŸ·è¡Œç·’**

> ç•¶æœ‰å®¢â¼¾ç«¯è«‹æ±‚å’Œä¾‹é …å»ºç«‹ Socket é€£ç·šæ™‚ï¼Œä¸»åŸ·è¡Œç·’æœƒå»ºç«‹å’Œå®¢æˆ¶ç«¯çš„é€£ç·šï¼Œä¸¦æŠŠ Socket æ”¾å…¥å…¨åŸŸæ€§ç­‰å¾…ä½‡åˆ—ä¸­ã€‚ç„¶å¾Œä¸»åŸ·è¡Œç·’é€šéè¼ªè©¢æ–¹æ³•æŠŠ Socket é€£ç·šåˆ†é…çµ¦ IO åŸ·è¡Œç·’ã€‚

> **éšæ®µäºŒï¼šIO åŸ·è¡Œç·’è®€å–ä¸¦è§£æè«‹æ±‚**

> ä¸»åŸ·è¡Œç·’æŠŠ Socket åˆ†é…çµ¦ IO åŸ·è¡Œç·’å¾Œï¼Œæœƒé€²â¼Šé˜»å¡ç‹€æ…‹ç­‰å¾… IO åŸ·è¡Œç·’å®Œæˆå®¢æˆ¶ç«¯è«‹æ±‚è®€å–å’Œè§£æã€‚

> **éšæ®µä¸‰ï¼šä¸»åŸ·è¡Œç·’åŸ·â¾è«‹æ±‚æ“ä½œ**

> IO åŸ·è¡Œç·’è§£æå®Œè«‹æ±‚å¾Œï¼Œä¸»åŸ·è¡Œç·’ä»¥å–®åŸ·è¡Œç·’çš„â½…å¼åŸ·â¾é€™äº›å‘½ä»¤æ“ä½œã€‚

> **éšæ®µå››ï¼šIO åŸ·è¡Œç·’å›å¯« Socket å’Œä¸»åŸ·è¡Œç·’æ¸…ç©ºå…¨åŸŸæ€§éšŠ**

> ä¸»åŸ·è¡Œç·’åŸ·è¡Œå®Œè«‹æ±‚æ“ä½œå¾Œï¼ŒæœƒæŠŠéœ€è¦è¿”å›çš„çµæœå¯«å…¥ç·©è¡å€ã€‚ç„¶å¾Œï¼Œä¸»åŸ·è¡Œç·’æœƒé˜»å¡ç­‰å¾… IO åŸ·è¡Œç·’æŠŠé€™äº›çµæœå›å¯«åˆ° Socket ä¸­ï¼Œä¸¦è¿”å›çµ¦å®¢æˆ¶ç«¯ã€‚ç­‰åˆ° IO åŸ·è¡Œç·’å›å¯« Socket å®Œç•¢ï¼Œä¸»åŸ·è¡Œç·’æœƒæ¸…ç©ºå…¨åŸŸæ€§ä½‡åˆ—ï¼Œç­‰å¾…å®¢æˆ¶ç«¯çš„å¾ŒçºŒè«‹æ±‚ã€‚

é‡é»ï¼š
- Redis åŸæœ¬æ˜¯ç”±å–®å€‹åŸ·è¡Œç·’è² è²¬ç¶²è·¯è«‹æ±‚I/Oã€æŒ‡ä»¤åŸ·è¡Œï¼Œä½†ç”±æ–¼å®¢æˆ¶ç«¯æœ¬èº«ç¶²è·¯ç¡¬é«”ä¸Šå‡ç´šï¼Œé€™æœƒä½¿å‘Redisç™¼é€è«‹æ±‚é€Ÿç‡å¢åŠ ï¼Œä½¿å¾—Redisçš„å–®å€‹åŸ·è¡Œç·’é›£ä»¥æ‡‰ä»˜
- ç‚ºäº†è§£æ±ºä¸Šè¿°å•é¡Œï¼ŒRedisåœ¨6.0å»ºç«‹å¤šå€‹åŸ·è¡Œç·’ä¾†è² è²¬è™•ç†å®¢æˆ¶ç«¯ç¶²è·¯I/Oè«‹æ±‚ã€ä¸¦è§£æéœ€è¦åŸ·è¡ŒæŒ‡ä»¤æ˜¯ä»€éº¼ï¼Œæµç¨‹æœƒæ˜¯ï¼š
	- å…ˆæ›¿è² è²¬ç®¡ç†I/Oå¤šåŸ·è¡Œç·’çš„æ¨¡çµ„å»ºç«‹å¤šå€‹ä½‡åˆ—ï¼Œæ¯ä¸€æ¬¡å®¢æˆ¶ç«¯å‘redisä¼ºæœå™¨ç™¼é€è«‹æ±‚æ™‚ï¼Œä¸»åŸ·è¡Œç·’å°±å…ˆå°‡è©²è«‹æ±‚çš„socketæ”¾é€²ä½‡åˆ—ä¸­ã€‚
	- ç­‰åˆ°ä½‡åˆ—æ»¿çš„æ™‚å€™æˆ–è€…æ²’è«‹æ±‚çš„æ™‚å€™ï¼Œä¸»åŸ·è¡Œç·’å°±å¹³å‡åˆ†æ”¤çµ¦I/OåŸ·è¡Œç·’ä¸¦ç”±åŸ·è¡Œç·’ç¶å®šç‰¹å®šSocketä¾†å°ˆé–€æ¥æ”¶å…¶å®¢æˆ¶ç«¯å‚³é€éä¾†çš„å°åŒ…ã€‚
	- æ¥è‘—åœ¨I/OåŸ·è¡Œç·’é–‹å§‹è§£æå‰ï¼Œä¸»åŸ·è¡Œç·’æœƒä¿æŒç­‰å¾…ï¼Œ I/OåŸ·è¡Œç·’æ¥æ”¶åˆ°å°åŒ…å…§å®¹ä¸¦è§£ææˆæŒ‡ä»¤æ”¾ç½®redisçš„åŸ·è¡Œä½‡åˆ—ä¸­ï¼Œç­‰åˆ°I/OåŸ·è¡Œç·’éƒ½è§£æå®Œç•¢ä¹‹å°±æœƒç·©é†’ä¸»åŸ·è¡Œç·’ï¼Œredisä¸»åŸ·è¡Œç·’å°±å¾åŸ·è¡Œä½‡åˆ—ä¸­å–å‡ºä»»å‹™ä¸¦å°‡çµæœå¯«å…¥ç·©è¡å€ï¼Œä¸¦ä¸”å°‡çµæœå’Œå°æ‡‰socket ä¾†æ”¾å…¥ç‚ºè² è²¬ç®¡ç†I/Oå¤šåŸ·è¡Œç·’çš„æ¨¡çµ„æ‰€å»ºç«‹çš„å¤šå€‹ä½‡åˆ—
	- ç­‰åˆ°æ²’ä»»ä½•å…§å®¹èƒ½å¤ å‚³é€è‡³ä½‡åˆ—ï¼Œå°±åœ¨æ ¹æ“šsocketä¾†æºå°‡çµæœåˆ†ç™¼ç•¶åˆç¶å®šsocketçš„IOåŸ·è¡Œç·’ï¼Œç”±é€™äº›åŸ·è¡Œç·’æŒ‰ç…§ç·©è¡å€ä½ç½®å’Œsocketå›å¯«è‡³å°æ‡‰çš„å®¢æˆ¶ç«¯ï¼Œæ¥è‘—ä¸»åŸ·è¡Œç·’å°±ç­‰å¾…I/OåŸ·è¡Œç·’å›å¯«å®Œç•¢
	- å¯«å®Œå°±ç·©é†’ä¸»åŸ·è¡Œç·’ä¾†æ¸…ç©ºæ‰€æœ‰ä½‡åˆ—(I/O åŸ·è¡Œç·’çš„ç­‰å¾…ä½‡åˆ—ã€åŸ·è¡Œä½‡åˆ—)
æ ¹æ“š[[@fijismithyRedisSourceCode]]æ‰€æè¿°ï¼š
![](https://programmer.ink/images/think/50216a37090eb07355566e7e29242bbd.jpg)

Process Description:

> 1. The main thread is responsible for receiving the connection establishment request, obtaining the socket and putting it into the global waiting read processing queue
2. After the main thread handles the read event, it allocates these connections to these IO threads through RR(Round Robin)
3. The main thread is blocked, waiting for the IO thread to read the socket
4. The main thread executes the request command through a single thread, and the request data is read and parsed, but it does not execute
5. The main thread is blocked, waiting for the IO thread to write data back to the socket
6. Unbind and empty the waiting queue

![](https://programmer.ink/images/think/a0d97ae13fed61789fe16adc66babc65.jpg)
### socket å…§å®¹
1. å«æœ‰è«‹æ±‚å…§å®¹/å›æ‡‰å…§å®¹ã€è«‹æ±‚æ–¹è³‡è¨Š(IPã€åŸŸåã€Port)ã€å›æ‡‰æ–¹è³‡è¨Š(IPã€åŸŸåã€Port)

## è¤‡ç¿’
#ğŸ§  ç„¡å¤šåŸ·è¡Œç·’çš„redisç‰ˆæœ¬ä¸‹ï¼Œå¦‚ä½•è™•ç†æ¯å€‹è«‹æ±‚çš„ï¼Ÿ(æç¤ºï¼šè«‹è€ƒé‡socketã€queueã€ç·©è¡å€bufferã€å›å¯«) ![](https://programmer.ink/images/think/50216a37090eb07355566e7e29242bbd.jpg)->->-> `- å–®åŸ·è¡Œç·’ä¸‹æœƒèˆ‡å®¢æˆ¶ç«¯å»ºç«‹é€£ç·šä»¥åŠsocketä¾†æ¥æ”¶å°æ‡‰çš„æŒ‡ä»¤ - é€™äº›æŒ‡ä»¤æœƒä¾åºæ”¾åœ¨æŒ‡ä»¤ä½‡åˆ—ä¸­ï¼Œredis ä¸»è¦åŸ·è¡Œç·’æœƒå¾ä½‡åˆ—ä¸­å–å‡ºæŒ‡ä»¤åŸ·è¡Œä¸¦å°‡çµæœæ”¾å…¥ç·©è¡å€ - ç­‰åˆ°æ‰€æœ‰æŒ‡ä»¤åŸ·è¡Œå®Œç•¢å¾Œï¼Œå°±è² è²¬æŒ‰ç…§socketè³‡è¨Šå°‡æ‰€æœ‰æŒ‡ä»¤çš„çµæœå›å¯«è‡³å°æ‡‰clientç«¯`

#ğŸ§  å¤šåŸ·è¡Œç·’çš„redisç‰ˆæœ¬ä¸‹ï¼Œå¦‚ä½•è™•ç†æ¯å€‹è«‹æ±‚çš„ï¼Ÿ(æç¤ºï¼šè«‹è€ƒé‡socketã€ioåŸ·è¡Œç·’ã€queueã€ç·©è¡å€bufferã€å›å¯«)  ![](https://programmer.ink/images/think/50216a37090eb07355566e7e29242bbd.jpg)->->-> `- å…ˆæ›¿è² è²¬ç®¡ç†I/Oå¤šåŸ·è¡Œç·’çš„æ¨¡çµ„å»ºç«‹å¤šå€‹ä½‡åˆ—ï¼Œæ¯ä¸€æ¬¡å®¢æˆ¶ç«¯å‘redisä¼ºæœå™¨ç™¼é€è«‹æ±‚æ™‚ï¼Œä¸»åŸ·è¡Œç·’å°±å…ˆå°‡è©²è«‹æ±‚çš„socketæ”¾é€²ä½‡åˆ—ä¸­ã€‚ - ç­‰åˆ°ä½‡åˆ—æ»¿çš„æ™‚å€™æˆ–è€…æ²’è«‹æ±‚çš„æ™‚å€™ï¼Œä¸»åŸ·è¡Œç·’å°±å¹³å‡åˆ†æ”¤çµ¦I/OåŸ·è¡Œç·’ä¸¦ç”±åŸ·è¡Œç·’ç¶å®šç‰¹å®šSocketä¾†å°ˆé–€æ¥æ”¶å…¶å®¢æˆ¶ç«¯å‚³é€éä¾†çš„å°åŒ…ã€‚ - æ¥è‘—åœ¨I/OåŸ·è¡Œç·’é–‹å§‹è§£æå‰ï¼Œä¸»åŸ·è¡Œç·’æœƒä¿æŒç­‰å¾…ï¼Œ I/OåŸ·è¡Œç·’æ¥æ”¶åˆ°å°åŒ…å…§å®¹ä¸¦è§£ææˆæŒ‡ä»¤æ”¾ç½®redisçš„åŸ·è¡Œä½‡åˆ—ä¸­ï¼Œç­‰åˆ°I/OåŸ·è¡Œç·’éƒ½è§£æå®Œç•¢ä¹‹å°±æœƒç·©é†’ä¸»åŸ·è¡Œç·’ï¼Œredisä¸»åŸ·è¡Œç·’å°±å¾åŸ·è¡Œä½‡åˆ—ä¸­å–å‡ºä»»å‹™ä¸¦å°‡çµæœå¯«å…¥ç·©è¡å€ï¼Œä¸¦ä¸”å°‡çµæœå’Œå°æ‡‰socket ä¾†æ”¾å…¥ç‚ºè² è²¬ç®¡ç†I/Oå¤šåŸ·è¡Œç·’çš„æ¨¡çµ„æ‰€å»ºç«‹çš„å¤šå€‹ä½‡åˆ— - ç­‰åˆ°æ²’ä»»ä½•å…§å®¹èƒ½å¤ å‚³é€è‡³ä½‡åˆ—ï¼Œå°±åœ¨æ ¹æ“šsocketä¾†æºå°‡çµæœåˆ†ç™¼ç•¶åˆç¶å®šsocketçš„IOåŸ·è¡Œç·’ï¼Œç”±é€™äº›åŸ·è¡Œç·’æŒ‰ç…§ç·©è¡å€ä½ç½®å’Œsocketå›å¯«è‡³å°æ‡‰çš„å®¢æˆ¶ç«¯ï¼Œæ¥è‘—ä¸»åŸ·è¡Œç·’å°±ç­‰å¾…I/OåŸ·è¡Œç·’å›å¯«å®Œç•¢ - å¯«å®Œå°±ç·©é†’ä¸»åŸ·è¡Œç·’ä¾†æ¸…ç©ºæ‰€æœ‰ä½‡åˆ—(I/O åŸ·è¡Œç·’çš„ç­‰å¾…ä½‡åˆ—ã€åŸ·è¡Œä½‡åˆ—)`

#ğŸ§  Redis å–®åŸ·è¡Œç·’åœ¨3.0åŸæœ¬æ˜¯åšä»€éº¼ç”¨é€”ï¼Ÿ->->-> `è² è²¬ç¶²è·¯è«‹æ±‚I/Oã€è§£æã€æŒ‡ä»¤åŸ·è¡Œã€å°‡çµæœå›å¯«`

#ğŸ§  Redis å–®åŸ·è¡Œç·’åœ¨6.0 æ˜¯åšä»€éº¼ç”¨é€”ï¼Ÿ->->-> `æŒ‡ä»¤åŸ·è¡Œã€å°‡çµæœå›å¯«åˆ†ç™¼çµ¦I/OåŸ·è¡Œç·’`

#ğŸ§  Redis  å¤šåŸ·è¡Œç·’æ˜¯ç”¨ä¾†åšä»€éº¼ï¼Ÿ æ¯”å¦‚ï¼Ÿ->->-> `ä¸»è¦æ˜¯åœ¨ä¸å½±éŸ¿ä¸»è¦åŸ·è¡Œç·’çš„åŸæœ¬è¨­è¨ˆåˆè¡·-ä¸ç”¢ç”Ÿrace coditionæƒ…æ³ä¸‹ä¾†ï¼Œå¹³æ”¤å…¶åŸ·è¡Œç·’çš„åŸ·è¡Œå£“åŠ›ï¼Œæ¯”å¦‚èªªè² è²¬è™•ç†æª”æ¡ˆé—œé–‰ã€ç·©è¡è³‡æ–™å›å¯«è‡³ç¡¬ç¢Ÿã€è¨˜æ†¶é«”å›æ”¶ã€ç¶²è·¯è«‹æ±‚I/O`

---
Status: #ğŸŒ± 
Tags:
[[Redis]] - [[Operating System]]
Links:
References:
[[@MianShiGuanWenRedisShiDanZhiXingXuHuanShiDuoZhiXingXu]]
[[@fijismithyRedisSourceCode]]